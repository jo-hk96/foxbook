<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fox.booklist.mapper.BooklistMapper">



	<!--대여중인 책의 갯수 -->
	<select id="renCount" resultType="int">
			SELECT count(*)
			FROM yb_book_info ybi, yb_rental_info yri 
			WHERE 
		    yri.yu_userid = #{yu_userid}
		    AND ybi.ybi_idx = yri.ybi_idx
		    AND yri.yri_redate IS NULL
	</select>
	
	

	<!-- 대여책 리스트 -->
	<select id = "rentalList">
		SELECT YBI.YBI_IDX, YBI.YBI_SUBJECT, YBI.ybi_publi, YBI.YBI_NAME, to_char(YRI.YRI_RTDATE,'YYYY-MM-DD HH24:MI:SS') YRI_RTDATE, 
		'대여중' AS YRI_REDATE
      FROM YB_BOOK_INFO YBI, YB_RENTAL_INFO YRI
      WHERE YRI.YU_USERID= #{yu_userid} AND YBI.YBI_IDX = YRI.YBI_IDX and yri.yri_redate is null
       <if test="params.keyword != null and params.keyword != ''">
       		 AND YBI.YBI_SUBJECT LIKE '%' || #{params.keyword} || '%'
   	   </if>
      ORDER BY yri_rtdate desc
   OFFSET #{params.offset} ROWS FETCH NEXT #{params.recordSize} ROWS ONLY
	</select>
	
	
	<!-- 반납책 리스트 -->
	<select id = "returnList">
      SELECT YBI.YBI_IDX, YBI.YBI_SUBJECT, YBI.ybi_publi, YBI.YBI_NAME, to_char(YRI.YRI_RTDATE,'YYYY-MM-DD AM HH24:MI:SS') YRI_RTDATE, 
	  to_char(YRI.YRI_REDATE,'YYYY-MM-DD HH24:MI:SS') as YRI_REDATE
      FROM YB_BOOK_INFO YBI, YB_RENTAL_INFO YRI
      WHERE YRI.YU_USERID = #{yu_userid} AND YBI.YBI_IDX = YRI.YBI_IDX and yri.yri_redate is not null
       <if test="params.keyword != null and params.keyword != ''">
         AND YBI.YBI_SUBJECT LIKE '%' || #{params.keyword} || '%'
       </if>
     ORDER BY yri_redate desc
     OFFSET #{params.offset} ROWS FETCH NEXT #{params.recordSize} ROWS ONLY
	</select>
	
	<!-- 도서전체리스트 목록조회  -->
	<select id="getBookList" resultType="com.fox.booklist.domain.booklistDTO">
   SELECT 
        YBI.YBI_IDX, YBI.YBI_SUBJECT, YBI.YBI_PUBLI, YBI.YBI_NAME, YBI.YBI_RENTAL,
      CASE when max(CASE WHEN YRI.YU_USERID = #{yu_userid} AND YRI.YRI_REDATE IS NULL THEN '대여중' ELSE NULL END) = '대여중' THEN '대여중' ELSE '대여가능' END as rentalst
    FROM yb_book_info YBI
    LEFT JOIN yb_rental_info YRI ON YBI.ybi_idx = YRI.ybi_idx
    <where>
        <if test="params.keyword != null and params.keyword != ''">
            YBI.YBI_SUBJECT LIKE '%' || #{params.keyword} || '%'
        </if>
    </where>
     GROUP BY
    YBI.YBI_IDX, YBI.YBI_SUBJECT, YBI.YBI_PUBLI, YBI.YBI_NAME, YBI.YBI_RENTAL
    having CASE when max (case when YRI.YU_USERID = #{yu_userid} AND YRI.YRI_REDATE IS NULL THEN '대여중' ELSE NULL END) = '대여중' THEN '대여중' ELSE '대여가능' END = '대여가능'
    ORDER BY YBI.ybi_subject asc
    OFFSET #{params.offset} ROWS FETCH NEXT #{params.recordSize} ROWS ONLY
</select>
	
	
</mapper>